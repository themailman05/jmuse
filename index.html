<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>PlayIt</title>
    <link href='//fonts.googleapis.com/css?family=Roboto:300,400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/materialize/0.95.3/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.2/moment.min.js" type="text/javascript"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
</head>
<body>
	<nav class="grey lighten-5" role="navigation">
		<div class="nav-wrapper container">
		<a id="logo-container" href="//educ.jmu.edu/~sargenlt/jmuse/" class="brand-logo">
			<img src="static/img/playIt_logo.png" style="margin-top:6px;" />
		</a>
			<ul class="right">
        		<li style="padding-left:10px;padding-right:10px;cursor:pointer;" id="addBtn"><i class="mdi-content-add light-blue-text" id="addIcon"></i></li>
        		<li style="padding-left:10px;padding-right:10px;cursor:pointer;" id="playBtn"><i class="mdi-av-play-arrow light-blue-text" id="playIcon"></i></li>
        		<li style="padding-left:10px;padding-right:10px;cursor:pointer;" id="clearBtn"><i class="mdi-content-clear light-blue-text" id="clearIcon"></i></li>
      		</ul>
      		<input type="file" name="localFileDiag" id="localFileDiag" style="display:none;" accept="audio/*"/>
		</div>
	</nav>
	<div class="section no-pad-bot" id="index-banner">
		<div class="container">
			<div class="row" style="margin-top:16px;">
				<div class="col s7">
					<h1 class="header orange-text">Playing Gemini</h1>
					<h5 class="header col s12 light">Audio Playback and Visualization Engine</h5>
				</div>
				<div class="col s5" style="margin-top:16px;">
					<h3 class="header orange-text">Playlist</h3>
					<ul class="collapsible" data-collapsible="accordion" id="playlistGUI">

  					</ul>
				</div>
			</div>
			<div class="row">
				<div class="col s12">
					<h5 class="header orange-text">PlayIt Instructions</h5>
					<ol>
						<li>Click the + sign to add a new file to the playlist.  Files are added locally so no files are uploaded to the server.</li>	
						<li>You may add multiple audio files, the files will be added to the playlist above.</li>
						<li>Select the song/audio file that you would like to listen to and use the audio control at in the top right corner to "Play", "Pause", and "Clear" the playlist.</li>
					</ol>
				</div>
			</div>
		</div>
	</div>

	<audio id="player" preload="auto">
		Your browser does not support the audio element.
	</audio>
	<audio id="temp" preload="auto"></audio>
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.95.3/js/materialize.min.js"></script>
	<script type="text/javascript">
        window.indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.OIndexedDB || window.msIndexedDB,
                IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.OIDBTransaction || window.msIDBTransaction,
                dbVersion = 1;

            openDB();
            refreshPlaylist();

		$(document).ready(function() {

			var items = 0,
					playing = 0,
					playlist = [],
					player = $("#player").get(0),
					playlistGUI = $("#playlistGUI ul"),
					time = new Date(),
					formattedTime = time.getHours() + ":" + time.getMinutes(),
					duration,
					objectURL,
					fileName,
					fileType,
					fileSize;
            var dbname = "AudioDB";

			$("#temp").on("canplaythrough", function (e) {
				var seconds = e.currentTarget.duration;
				var duration = moment.duration(seconds, "seconds");

				var time = "";
				var hours = duration.hours();
				var minutes = duration.minutes();
				var seconds = duration.seconds();
				if (hours > 0) {
					time = hours + ":";
				}
				if (minutes == 0) {
					minutes = "00";
				}
				if (seconds < 10 && seconds != 0) {
					seconds = "0" + seconds;
				}
				else if (seconds == 0) {
					seconds = "00";
				}

				time = time + duration.minutes() + ":" + seconds;
				duration = time;
				$("#duration" + (items - 1)).text(duration);

				/*URL.revokeObjectURL(objectUrl);*/
			});
            /*var items = 0;
			var playing = 0;
			var playlist = [];
			var player = $("#player").get(0);
			var playlistGUI = $("#playlistGUI ul");
			var time = new Date();
			var formattedTime = time.getHours() + ":" + time.getMinutes();*/

			$('#addBtn').on('click', function (e) {
				e.preventDefault();
				$('#localFileDiag').trigger('click');
			});

			$("#playBtn").click(function () {
				if (items == 0) {
					alert("Playlist Empty");
				}
				else {
					if (player.paused) {
						player.src = playlist[playing];
						player.play();
						$("#playIcon").removeClass("mdi-av-play-arrow").addClass("mdi-av-pause");
                        playFromDB("The Pot");
					}
					else {
						player.pause();
						$("#playIcon").removeClass("mdi-av-pause").addClass("mdi-av-play-arrow");
					}
				}
			});

			$("#clearBtn").click(function () {
				clearPlaylist();
			});

			$('.collapsible').collapsible({
				accordion: false // A setting that changes the collapsible behavior to expandable instead of the default accordion style
			});

			$('#localFileDiag').on('change', function (e) {

				var files = this.files;
				var file = URL.createObjectURL(files[0]);
                var songName = prompt("Song Title:");
                var artist = prompt("Artist:");
				addToPlaylist(file, songName, artist);
				$("#temp").prop("src", file);
				handleFileSelect(files[0], songName, artist);
			});

			function handleFileSelect(file, songName, artist) {
				    console.log(file);
					fr = new FileReader();
					fr.readAsArrayBuffer(file);
                    fr.onload = function(){
                        console.log("FIleReader output: " + fr.result);
                        writeToDB(fr.result, songName);

                };


			}


			$('#player').on('ended', function () {
				playNext();
			});

			function addToPlaylist(itemToAdd, songName, artist) {
				updateTotal();
				$("#playlistGUI").append('<li id="song' + (items - 1) + '"><div class="collapsible-header">' + songName + ' - ' + artist + '</div><div class="collapsible-body"><p>Song Title: ' + songName + '<br />Artist: ' + artist + '<br />Duration: <span id="duration' + (items - 1) + '"></span></p></div></li>');
				playlist[items - 1] = itemToAdd;
			}

			function updateTotal() {
				items++;
			}

			function playNext() {
				playing++;
				if (playing == items) {
					playing = 0;
				}

				player.src = playlist[playing];
				player.play();

			}

			function getTime() {
				return formattedTime;
			}

			function clearPlaylist() {
				$("#playlistGUI").empty();
				items = 0;
				playing = 0;
				player.pause();
				$("#playIcon").removeClass("mdi-av-pause").addClass("mdi-av-play-arrow");
				player.src = null;
				playlist = [];
			}
		
		});

			function openDB() {
                if("indexedDB" in window) {
                    idbSupported = true;
                }

                if(idbSupported) {
                    var openRequest = indexedDB.open("audioFilesStore",1);

                    openRequest.onupgradeneeded = function(e) {
                        console.log("running onupgradeneeded");
                        var db = e.target.result;

                        if(!db.objectStoreNames.contains("audioFiles")) {
                            db.createObjectStore("audioFiles");
                        }

                    };

                    openRequest.onsuccess = function(e) {
                        console.log("Success!");
                        db = e.target.result;
                    };

                    openRequest.onerror = function(e) {
                        console.log("Error");
                        console.dir(e);
                    };

                }
			}

			function writeToDB(file1, songName) {
                var transaction = db.transaction(["audioFiles"],"readwrite");
                var store = transaction.objectStore("audioFiles");
                console.log(file1);
                var request = store.add(file1, songName);


                /*request.onsuccess = function (event) {
					db = event.target.result;
					console.log(db)
					var transaction = db.transaction("audioFiles",  "readwrite", 2000);
					transaction.oncomplete = function(){
						console.log("Success transaction");
                        var trans = db.transaction("audioFiles", READ_WRITE);
                        trans.objectStore("audioFiles").put(myArrayBuffer, "titleKey");
					};
					*/



            }
            function playFromDB(songName) {
                var transaction = db.transaction(["audioFiles"], "readwrite");
                var store = transaction.objectStore("audioFiles");
                thesong = store.get(songName);
                thesong.onerror = function(event) {
                    console.log("OH FUCK LOADING SHITS BROKE");
                };
                thesong.onsuccess = function(event) {
                    // Do something with the request.result!
                    alert("song retrieved: " + thesong.result.toString());
                    console.log(thesong.result);

                };

            }

            function refreshPlaylist(){
                var transaction = db.transaction(["audioFiles"], "readwrite");
                var store = transaction.objectStore("audioFiles");
                objrequest = store.getAll();

                objrequest.onsuccess = function(e) {
                    for (ii = 0; ii < request.result.length; ii++) {
                        url = windows.url.createobjectURL(request.result);
                        addToPlaylist(request.result, "textsong", "test");
                    }
                };
            }
	</script>
    <!-- <script src="js/drummachine.js"></script> -->
    
    <!-- <input type="file" style="visibility:hidden;" id="uploadme" /> -->
    <!-- <input type="button" id="clickme" value="Upload mp3!" /> -->
    
   
    
    <!-- <button id ='drumMachine'>Drum Machine GO</button> -->
        <!-- <script type="text/javascript"> -->
            <!-- document.getElementById("drumMachine").addEventListener("click", drumMachine()); -->
        <!-- </script> -->


	<!---<iframe id="debuggerId" class="debuggerContainer" src="IDBExplorer/IDBExplorer.html?name=audioFileDB"></iframe>--->

	</body>
</html>